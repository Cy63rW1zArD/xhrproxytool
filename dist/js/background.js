!function(){"use strict";var e={init:function(){this.initConnect()},initConnect:function(){var e=this;chrome.runtime.onConnect.addListener(function(t){switch(t.name){case"send-request":e.sendRequestHandler(t);break;case"page-script-error":e.showPageScriptError(t);break;case"exec-scripts":e.execScriptsHandler(t)}}),chrome.runtime.onMessageExternal.addListener(function(e,t,n){"inject-content-script"===e.name&&chrome.tabs.executeScript(t.tab.id,{file:"js/xhrproxy.page.js"})})},sendRequestHandler:function(e){e.onMessage.addListener(function(t){var n=new XMLHttpRequest,a="",r=t.method.toUpperCase(),s=t.url.trim();/^https?\:/.test(s)||(s="http://"+s);var o=t.headers||{};if(o["Content-Type"]||(o["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8"),/^number|string|boolean$/.test(typeof t.data))a=String(t.data);else for(var i in t.data)a&&(a+="&"),a+=i+"="+t.data[i];var c=[];if(Object.keys(t.data).forEach(function(e){var n=t.data[e];n.__isFile__&&c.push(new Promise(function(a,r){var s=new XMLHttpRequest;s.open("GET",n.blobUrl,!0),s.responseType="blob",s.onload=function(r){if(200==this.status){var s=this.response;t.data[e]=new File([s],n.filename,{type:s.type}),a()}},s.send()}))}),"GET"===r)a&&(s+="?"+a);else if("application/json"===o["Content-Type"])a=JSON.stringify(t.data);else if("multipart/form-data"===o["Content-Type"]){var d=new FormData;c.length?Promise.all(c).then(function(){Object.keys(t.data).forEach(function(e){d.append(e,t.data[e])}),n.send(d)}):(Object.keys(t.data).forEach(function(e){d.append(e,t.data[e])}),a=d),delete o["Content-Type"]}n.open(r,s,!0);for(var p in o)n.setRequestHeader(p,o[p]);n.onreadystatechange=function(){if(4===this.readyState){var a={},r=["readyState","response","responseText","responseType","responseURL","responseXML","status","statusText","timeout","withCredentials"];r.forEach(function(e){a[e]=n[e]}),a.responseHeaders=this.getAllResponseHeaders(),chrome.tabs.sendMessage(e.sender.tab.id,{name:"send-request-res",data:n.responseText,reqData:t,xhr:a})}},c.length||n.send(a)})},showPageScriptError:function(e){var t=localStorage.xhr_proxy_tool_js_error_notify;"true"===t&&e.onMessage.addListener(function(e){var t=new Notification("脚本错误:",{icon:"./js/image.png",body:e.data.message+"\n"+e.data.filename+"\n"+e.data.lineno});setTimeout(function(){t.close()},3e3)})},execScriptsHandler:function(e){e.onMessage.addListener(function(t){var n=e.sender.tab.id,a=t.data;chrome.webNavigation.getAllFrames({tabId:n},function(e){console.log(a);var t=e.find(function(e){return e.url.startsWith(a.targetFrameUrl)});t?chrome.tabs.executeScript({code:a.scripts+";jasmineRun();",frameId:t.frameId}):console.log("没有找到目标 iframe 地址: "+a.targetFrameUrl)})})}};e.init()}();